---
# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component
resources:
  - ./service.yaml
  - ./httproute.yaml
patches:
  - target:
      kind: HelmRelease
    patch: |-
      apiVersion: helm.toolkit.fluxcd.io/v2
      kind: HelmRelease
      metadata:
        name: not-used
      spec:
        postRenderers:
          - kustomize:
              patches:
                - target:
                    kind: Deployment
                    name: ${APP}
                  patch: |-
                    - op: add
                      path: /spec/template/spec/containers/-
                      value:
                        name: code-server
                        image: ghcr.io/coder/code-server:4.104.3@sha256:8a4f9ec985bcb022de1ae70fab74e3a2c3199b2bc44665df6da203c3ada1643a
                        args:
                          - --auth
                          - none
                          - --disable-telemetry
                          - --disable-update-check
                          - --user-data-dir
                          - /mnt/.code-server
                          - --extensions-dir
                          - /mnt/.code-server
                          - --port
                          - "80"
                          - /mnt
                        ports:
                          - name: code-server
                            containerPort: 80
                            protocol: TCP
                        volumeMounts:
                          - name: ${CODE_SERVER_VOLUME:=config}
                            mountPath: /mnt
                          - name: code-server-tmpfs
                            mountPath: /tmp
                          - name: code-server-tmpfs
                            mountPath: /nonexistent
                        resources:
                          requests:
                            cpu: 10m
                          limits:
                            memory: 512Mi
                    - op: add
                      path: /spec/template/spec/volumes/-
                      value:
                        name: code-server-tmpfs
                        emptyDir: {}
