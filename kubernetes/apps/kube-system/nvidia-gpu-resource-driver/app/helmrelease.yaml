---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: nvidia-gpu-resource-driver
spec:
  chartRef:
    kind: OCIRepository
    name: nvidia-gpu-resource-driver
  interval: 1h
  postRenderers:
    - kustomize:
        # Fix CDI path
        patches:
          - target:
              kind: DaemonSet
              name: nvidia-dra-driver-gpu-kubelet-plugin
            patch: |
              - op: replace
                path: /spec/template/spec/containers/0/volumeMounts/2/mountPath
                value: "/var/cdi/static"
          - target:
              kind: DaemonSet
              name: nvidia-dra-driver-gpu-kubelet-plugin
            patch: |
              - op: replace
                path: /spec/template/spec/volumes/2/hostPath/path
                value: "/var/cdi/static"
          - target:
              kind: DaemonSet
              name: nvidia-dra-driver-gpu-kubelet-plugin
            patch: |
              - op: replace
                path: /spec/template/spec/containers/0/env/3/value
                value: "/var/cdi/static"
  values:
    gpuResourcesEnabledOverride: true
    image:
      repository: ghcr.io/hydazz/k8s-dra-driver-gpu
      tag: v25.8.0-dev@sha256:e49ee7160a2a99d2e7278c879595329fe96eac15afc94ee7e36a6b5fcdbb3ada
    resources:
      gpus:
        enabled: true
      computeDomains:
        enabled: false
