worker_processes auto;
error_log /var/log/nginx/error.log notice;
pid /var/run/nginx.pid;

events {
	worker_connections 1024;
}

http {
	include /etc/nginx/mime.types;
	default_type application/octet-stream;

	log_format main '$remote_addr - $remote_user [$time_local] "$request" '
	'$status $body_bytes_sent "$http_referer" '
	'"$http_user_agent" "$http_x_forwarded_for"';

	access_log /var/log/nginx/access.log main;

	sendfile on;
	tcp_nopush on;
	keepalive_timeout 65;
	gzip on;
	gzip_vary on;
	gzip_min_length 1000;
	gzip_types
	application/atom+xml
	application/javascript
	application/json
	application/ld+json
	application/manifest+json
	application/rss+xml
	application/vnd.geo+json
	application/vnd.ms-fontobject
	application/x-font-ttf
	application/x-web-app-manifest+json
	application/xhtml+xml
	application/xml
	font/opentype
	image/bmp
	image/svg+xml
	image/x-icon
	text/cache-manifest
	text/css
	text/plain
	text/vcard
	text/vnd.rim.location.xloc
	text/vtt
	text/x-component
	text/x-cross-domain-policy;

	# Security headers
	add_header X-Content-Type-Options nosniff;
	add_header X-Frame-Options SAMEORIGIN;
	add_header X-XSS-Protection "1; mode=block";

	server {
		listen 8080;
		server_name _;
		root /var/www/html;
		index index.php;

		# Health check endpoint
		location /nginx-health {
			access_log off;
			return 200 "healthy\n";
			add_header Content-Type text/plain;
		}

		# WordPress specific configuration
		location / {
			try_files $uri $uri/ /index.php?$args;
		}

		# Handle PHP files
		location ~ \.php$ {
			fastcgi_split_path_info ^(.+\.php)(/.+)$;
			fastcgi_pass 127.0.0.1:9000;
			fastcgi_index index.php;
			include fastcgi_params;
			fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
			fastcgi_param PATH_INFO $fastcgi_path_info;
			fastcgi_param HTTPS on;
			fastcgi_read_timeout 300;
		}

		# Deny access to sensitive files
		location ~ /\. {
			deny all;
		}

		location ~ ^/(wp-config\.php|wp-config-sample\.php|readme\.html|license\.txt)$ {
			deny all;
		}

		# Block access to backup and log files
		location ~* \.(bak|backup|log|old|orig|original|php#|php~|php_bak|save|swo|swp|tmp)$ {
			deny all;
		}

		# WordPress uploads and static files
		location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
			expires 1y;
			add_header Cache-Control "public, immutable";
			add_header Vary Accept-Encoding;
		}

		# WordPress feeds
		location ~* \.(rss|atom)$ {
			expires 1h;
			add_header Cache-Control "public";
		}

		# Block access to xmlrpc.php
		location = /xmlrpc.php {
			deny all;
		}

		# Block access to wp-admin for non-authenticated users
		location /wp-admin/ {
			try_files $uri $uri/ /wp-admin/index.php?$args;
		}
	}
}
