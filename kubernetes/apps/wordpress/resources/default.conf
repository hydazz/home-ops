server {
	listen 8080;
	server_name _;
	root /var/www/html;
	index index.php;

	# Real client IP handling (context: http|server)
	real_ip_header X-Forwarded-For;
	set_real_ip_from 10.42.0.0/16;
	set_real_ip_from 192.168.42.0/24;
	real_ip_recursive on;

	# Body size aligned with PHP limits (context: http|server|location)
	client_max_body_size 128M;

	# BEGIN W3TC Browser Cache (compression + caching rules)
	gzip on;
	gzip_vary on;
	gzip_min_length 1000;
	gzip_types text/css text/x-component application/x-javascript application/javascript text/javascript text/x-js text/richtext text/plain text/xsd text/xsl text/xml image/bmp application/java application/msword application/vnd.ms-fontobject application/x-msdownload image/x-icon application/json application/vnd.ms-access video/webm application/vnd.ms-project application/x-font-otf application/vnd.ms-opentype application/vnd.oasis.opendocument.database application/vnd.oasis.opendocument.chart application/vnd.oasis.opendocument.formula application/vnd.oasis.opendocument.graphics application/vnd.oasis.opendocument.spreadsheet application/vnd.oasis.opendocument.text audio/ogg application/pdf application/vnd.ms-powerpoint image/svg+xml application/x-shockwave-flash image/tiff application/x-font-ttf audio/wav application/vnd.ms-write application/font-woff application/font-woff2 application/vnd.ms-excel;

	location ~ \.(css|htc|less|js|js2|js3|js4)$ {
		expires 31536000s;
		etag on;
		if_modified_since exact;
		add_header Pragma "public";
		add_header Cache-Control "public";
		add_header Referrer-Policy "no-referrer-when-downgrade";
		try_files $uri $uri/ /index.php?$args;
	}
	location ~ \.(html|htm|rtf|rtx|txt|xsd|xsl|xml)$ {
		expires 3600s;
		etag on;
		if_modified_since exact;
		add_header Pragma "public";
		add_header Cache-Control "public";
		add_header Referrer-Policy "no-referrer-when-downgrade";
		try_files $uri $uri/ /index.php?$args;
	}
	location ~ \.(asf|asx|wax|wmv|wmx|avi|avif|avifs|bmp|class|divx|doc|docx|exe|gif|gz|gzip|ico|jpg|jpeg|jpe|webp|json|mdb|mid|midi|mov|qt|mp3|m4a|mp4|m4v|mpeg|mpg|mpe|webm|mpp|_otf|odb|odc|odf|odg|odp|ods|odt|ogg|ogv|pdf|png|pot|pps|ppt|pptx|ra|ram|svg|svgz|swf|tar|tif|tiff|_ttf|wav|wma|wri|xla|xls|xlsx|xlt|xlw|zip)$ {
		expires 31536000s;
		etag on;
		if_modified_since exact;
		add_header Pragma "public";
		add_header Cache-Control "public";
		add_header Referrer-Policy "no-referrer-when-downgrade";
		try_files $uri $uri/ /index.php?$args;
	}
	add_header Referrer-Policy "no-referrer-when-downgrade"; # ensure always present
	# END W3TC Browser Cache

	# Security headers
	add_header X-Content-Type-Options nosniff;
	add_header X-Frame-Options SAMEORIGIN;
	add_header X-XSS-Protection "1; mode=block";
	add_header Referrer-Policy "no-referrer-when-downgrade";

	location / {
		try_files $uri $uri/ /index.php?$args;
	}

	location ~ \.php$ {
		fastcgi_split_path_info ^(.+\.php)(/.+)$;
		fastcgi_pass 127.0.0.1:9000;
		fastcgi_index index.php;
		include fastcgi_params;
		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
		fastcgi_param PATH_INFO $fastcgi_path_info;
		fastcgi_read_timeout 300;
	}

	location ~ /\. {
		deny all;
	}
	location ~ ^/(wp-config\.php|wp-config-sample\.php|readme\.html|license\.txt)$ {
		deny all;
	}
	location ~* \.(bak|backup|log|old|orig|original|php#|php~|php_bak|save|swo|swp|tmp)$ {
		deny all;
	}

	location ~* \.(rss|atom)$ {
		expires 1h;
		add_header Cache-Control "public";
	}

	location = /xmlrpc.php {
		deny all;
	}
	location /wp-admin/ {
		try_files $uri $uri/ /wp-admin/index.php?$args;
	}
}
