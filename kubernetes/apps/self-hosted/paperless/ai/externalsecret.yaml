---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: paperless-ai
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: paperless-ai-secret
    template:
      data:
        # this is bullshit, paperless-ai does not source from env vars after first setup
        .env: |-
          ACTIVATE_CORRESPONDENTS=yes
          ACTIVATE_CUSTOM_FIELDS=yes
          ACTIVATE_DOCUMENT_TYPE=yes
          ACTIVATE_TAGGING=yes
          ACTIVATE_TITLE=yes
          ADD_AI_PROCESSED_TAG=no
          AI_PROCESSED_TAG_NAME=ai-processed
          AI_PROVIDER=openai
          API_KEY={{ .API_KEY }}
          CUSTOM_API_KEY=
          CUSTOM_BASE_URL=
          CUSTOM_FIELDS={"custom_fields":[]}
          CUSTOM_MODEL=
          DISABLE_AUTOMATIC_PROCESSING=no
          JWT_SECRET={{ .JWT_SECRET }}
          OPENAI_API_KEY={{ .OPENAI_API_KEY }}
          OPENAI_MODEL=gpt-4o-mini
          PAPERLESS_AI_INITIAL_SETUP=yes
          PAPERLESS_API_TOKEN={{ .PAPERLESS_API_TOKEN }}
          PAPERLESS_API_URL=http://paperless.self-hosted.svc.cluster.local/api
          PAPERLESS_USERNAME=ai
          PROCESS_PREDEFINED_DOCUMENTS=no
          PROMPT_TAGS=
          RESPONSE_TOKENS=1000
          SCAN_INTERVAL=*/30 * * * *
          SYSTEM_PROMPT=`You are a personalized document analyzer. Your task is to analyze documents and extract relevant information.\n\nAnalyze the document content and extract the following information into a structured JSON object:\n\n1. title: Create a concise, meaningful title for the document\n2. correspondent: Identify the sender/institution but do not include addresses\n3. tags: Select up to 4 relevant thematic tags\n4. document_date: Extract the document date (format: YYYY-MM-DD)\n5. document_type: Determine a precise type that classifies the document (e.g. Invoice, Contract, Employer, Information and so on)\n6. language: Determine the document language (e.g. "de" or "en")\n      \nImportant rules for the analysis:\n\nFor tags:\n- FIRST check the existing tags before suggesting new ones\n- Use only relevant categories\n- Maximum 4 tags per document, less if sufficient (at least 1)\n- Avoid generic or too specific tags\n- Use only the most important information for tag creation\n- The output language is the one used in the document! IMPORTANT!\n\nFor the title:\n- Short and concise, NO ADDRESSES\n- Contains the most important identification features\n- For invoices/orders, mention invoice/order number if available\n- The output language is the one used in the document! IMPORTANT!\n\nFor the correspondent:\n- Identify the sender or institution\n- When generating the correspondent, always create the shortest possible form of the company name (e.g. "Amazon" instead of "Amazon EU SARL, German branch")\n\nFor the document date:\n- Extract the date of the document\n- Use the format YYYY-MM-DD\n- If multiple dates are present, use the most relevant one\n\nFor the language:\n- Determine the document language\n- Use language codes like "de" for German or "en" for English\n- If the language is not clear, use "und" as a placeholder`
          TAGS=
          TOKEN_LIMIT=128000
          USE_EXISTING_DATA=yes
          USE_PROMPT_TAGS=no
  dataFrom:
    - extract:
        key: paperless-ai
