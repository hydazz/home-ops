---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app maddy
spec:
  chartRef:
    kind: OCIRepository
    name: maddy
  interval: 1h
  values:
    controllers:
      maddy:
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          app:
            image:
              repository: ghcr.io/foxcpp/maddy
              tag: 0.8.1@sha256:55636d8a29588eea62d81d51acdafe38e0f694fb91801ab12dc1ed8c47b6439d
            env:
              MADDY_HOSTNAME: mail.hyde.services
              MADDY_DOMAIN: hyde.services
              SMTP_PORT: &smtpPort 25
              SUBMISSION_PORT: &submissionPort 587
              SUBMISSIONS_PORT: &submissionsPort 465
              IMAP_PORT: &imapPort 143
              IMAPS_PORT: &imapsPort 993
            probes:
              liveness: &probes
                enabled: true
                custom: true
                spec:
                  tcpSocket:
                    port: *submissionPort
                  initialDelaySeconds: 0
                  periodSeconds: 10
                  timeoutSeconds: 1
                  failureThreshold: 3
              readiness: *probes
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: {drop: ["ALL"]}
            resources:
              requests:
                cpu: 50m
                memory: 128Mi
              limits:
                memory: 512Mi
    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
    service:
      app:
        #type: LoadBalancer
        #annotations:
        #  external-dns.alpha.kubernetes.io/hostname: mail.hyde.services
        #  lbipam.cilium.io/ips: 192.168.42.150
        #externalTrafficPolicy: Local
        ports:
          smtp:
            port: *smtpPort
          smtp-submission:
            port: *submissionPort
          smtp-submissions:
            port: *submissionsPort
          imap:
            port: *imapPort
          imaps:
            port: *imapsPort
    configMaps:
      config:
        data:
          maddy.conf: |-
            state_dir /data/state
            runtime_dir /cache/run

            $(hostname) = {env:MADDY_HOSTNAME}
            $(primary_domain) = {env:MADDY_DOMAIN}
            $(local_domains) = $(primary_domain) imagegenius.io ${D_HCA} ${D_SN} ${D_TACA} ${D_TAN} ${D_LMVCA} ${D_AHFYBC}

            tls file /certs/tls.crt /certs/tls.key
            hostname $(hostname)

            auth.pass_table local_authdb {
              table sql_table {
                driver sqlite3
                dsn /data/credentials.db
                table_name passwords
              }
            }

            storage.imapsql local_mailboxes {
              driver sqlite3
              dsn /data/imapsql.db
            }

            table.chain local_rewrites {
              optional_step regexp "(.+)\+(.+)@(.+)" "$1@$3"
              optional_step static {
                entry postmaster postmaster@$(primary_domain)
              }
            }

            msgpipeline local_routing {
              destination postmaster $(local_domains) {
                modify {
                  replace_rcpt &local_rewrites
                }
                deliver_to &local_mailboxes
              }
              default_destination {
                reject 550 5.1.1 "User doesn't exist"
              }
            }

            smtp tcp://0.0.0.0:{env:SMTP_PORT} {
              limits {
                all rate 50 1s
                all concurrency 20
              }
              dmarc yes
              check {
                require_mx_record
                dkim
                spf
              }
              source $(local_domains) {
                reject 501 5.1.8 "Use Submission for outgoing SMTP"
              }
              default_source {
                destination postmaster $(local_domains) {
                  deliver_to &local_routing
                }
                default_destination {
                  reject 550 5.1.1 "User doesn't exist"
                }
              }
            }

            submission tls://0.0.0.0:{env:SUBMISSIONS_PORT} tcp://0.0.0.0:{env:SUBMISSION_PORT} {
              limits {
                all rate 50 1s
              }
              auth &local_authdb
              source $(local_domains) {
                check {
                  authorize_sender {
                    prepare_email &local_rewrites
                    user_to_email identity
                  }
                }
                destination postmaster $(local_domains) {
                  deliver_to &local_routing
                }
                default_destination {
                  modify {
                    dkim $(primary_domain) $(local_domains) default
                  }
                  deliver_to &remote_queue
                }
              }
              default_source {
                reject 501 5.1.8 "Non-local sender domain"
              }
            }

            target.remote outbound_delivery {
              limits {
                destination rate 20 1s
                destination concurrency 10
              }
              mx_auth {
                dane
                mtasts {
                  cache fs
                  fs_dir /cache/mtasts_cache/
                }
                local_policy {
                  min_tls_level encrypted
                  min_mx_level none
                }
              }
            }

            target.queue remote_queue {
              target &outbound_delivery
              autogenerated_msg_domain $(primary_domain)
              bounce {
                destination postmaster $(local_domains) {
                  deliver_to &local_routing
                }
                default_destination {
                  reject 550 5.0.0 "Refusing to send DSNs to non-local addresses"
                }
              }
            }

            imap tls://0.0.0.0:{env:IMAPS_PORT} tcp://0.0.0.0:{env:IMAP_PORT} {
              auth &local_authdb
              storage &local_mailboxes
            }
    persistence:
      data:
        existingClaim: *app
      cache:
        type: emptyDir
      config-file:
        type: configMap
        identifier: config
        globalMounts:
          - path: /data/maddy.conf
            subPath: maddy.conf
      certs:
        type: secret
        name: hyde-services-tls
        globalMounts:
          - path: /certs
