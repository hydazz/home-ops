state_dir /data/state
runtime_dir /cache/run

$(hostname) = {env:MADDY_HOSTNAME}
$(primary_domain) = {env:MADDY_DOMAIN}
$(local_domains) = $(primary_domain) imagegenius.io ${D_SN} ${D_TACA} ${D_TAN} ${D_LMVCA} ${D_BBPC}
$(external_domains) = ${D_HCA}
$(sender_domains) = $(local_domains) $(external_domains)

tls file /certs/tls.crt /certs/tls.key

auth.pass_table local_authdb {
  table sql_table {
    driver sqlite3
    dsn /data/credentials.db
    table_name passwords
  }
}

storage.imapsql local_mailboxes {
  driver sqlite3
  dsn /data/imapsql.db
}

hostname $(hostname)

msgpipeline local_routing {
  check {
    require_mx_record
    dkim
    spf
  }
  destination postmaster $(local_domains) {
    modify {
      replace_rcpt regexp "(.+)\+(.+)@(.+)" "$1@$3"
      replace_rcpt file /data/aliases
    }
    reroute {
      destination postmaster $(local_domains) {
        deliver_to &local_mailboxes
      }
      default_destination {
        deliver_to &remote_queue
      }
    }
  }
  default_destination {
    reject 550 5.1.1 "User doesn't exist"
  }
}

smtp tcp://0.0.0.0:{env:SMTP_PORT} {
  limits {
    all rate 50 1s
    all concurrency 20
  }
  source $(sender_domains) {
    reject 501 5.1.8 "Use Submission for outgoing SMTP"
  }
  default_source {
    destination postmaster $(local_domains) {
      deliver_to &local_routing
    }
    default_destination {
      reject 550 5.1.1 "User doesn't exist"
    }
  }
}

submission tls://0.0.0.0:{env:SUBMISSIONS_PORT} tcp://0.0.0.0:{env:SUBMISSION_PORT} {
  limits {
    all rate 50 1s
  }
  auth &local_authdb
  source $(sender_domains) {
    destination postmaster $(local_domains) {
      deliver_to &local_routing
    }
    default_destination {
      modify {
        dkim $(sender_domains) default
      }
      deliver_to &remote_queue
    }
  }
  default_source {
    reject 501 5.1.8 "Non-local sender domain"
  }
}

target.remote outbound_delivery {
  limits {
    destination rate 20 1s
    destination concurrency 10
  }
  mx_auth {
    dane
    mtasts {
      cache fs
      fs_dir mtasts_cache/
    }
    local_policy {
      min_tls_level encrypted
      min_mx_level none
    }
  }
}

target.queue remote_queue {
  target &outbound_delivery
  autogenerated_msg_domain $(primary_domain)
  bounce {
    destination postmaster $(local_domains) {
      deliver_to &local_routing
    }
    default_destination {
      reject 550 5.0.0 "Refusing to send DSNs to non-local addresses"
    }
  }
}

imap tls://0.0.0.0:{env:IMAPS_PORT} tcp://0.0.0.0:{env:IMAP_PORT} {
  auth &local_authdb
  storage &local_mailboxes
}
