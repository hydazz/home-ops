---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: mailu
spec:
  chartRef:
    kind: OCIRepository
    name: mailu
  interval: 1h
  values:
    controllers:
      front:
        annotations: &reloader
          reloader.stakater.com/auto: "true"
        containers:
          app:
            image:
              repository: ghcr.io/mailu/nginx
              tag: 2024.06.44@sha256:a1eb6c0ccdae288618557fc5b5eba0bded9aae1bb8545fbe066986cbe5d5061f
            env:
              LETSENCRYPT_SHORTCHAIN: false
              REAL_IP_FROM: 0.0.0.0/0
              REAL_IP_HEADER: X-Forwarded-For
              WEBDAV: none
              WEBROOT_REDIRECT: /webmail
            envFrom:
              - configMapRef:
                  name: "{{ .Release.Name }}-env-configmap"
            probes:
              liveness: &frontProbes
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /
                    port: &port 80
                  initialDelaySeconds: 10
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 3
              readiness: *frontProbes
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
            #  capabilities:
            #    add:
            #      - NET_BIND_SERVICE
            #      - CHOWN
            #      - SETGID
            #      - SETUID
            #      - DAC_OVERRIDE
            #    drop:
            #      - ALL
            resources:
              requests:
                cpu: 10m
                memory: 256Mi
              limits:
                memory: 512Mi
      admin:
        annotations: *reloader
        containers:
          app:
            image:
              repository: ghcr.io/mailu/admin
              tag: 2024.06.44@sha256:34f58a371ecc80e48cfb7e75cf33cbeeaa909d4a170cd857765ec0f3a897e50a
            # Bypass Mailu's DNSSEC bullshit
            command:
              - sh
              - -c
              - |-
                flask mailu advertise
                flask db upgrade
                exec gunicorn \
                  --threads "${CPU_COUNT:-1}" \
                  -b "[::]:8080" \
                  --logger-class mailu.Logger \
                  --log-level "${LOG_LEVEL:-INFO}" \
                  --worker-tmp-dir /dev/shm \
                  --error-logfile - \
                  --access-logfile - \
                  --preload \
                  'mailu:create_app()'
            env:
              AUTH_RATELIMIT_EXEMPTION_LENGTH: "86400"
              AUTH_RATELIMIT_IP: 60/hour
              AUTH_RATELIMIT_IP_V4_MASK: "24"
              AUTH_RATELIMIT_IP_V6_MASK: "56"
              AUTH_RATELIMIT_USER: 100/day
              AUTH_REQUIRE_TOKENS: "false"
              BABEL_DEFAULT_LOCALE: en
              BABEL_DEFAULT_TIMEZONE: UTC
              BOOTSTRAP_SERVE_LOCAL: "true"
              CREDENTIAL_ROUNDS: "12"
              DB_FLAVOR: postgresql
              DEBUG: "false"
              DEBUG_PROFILER: "false"
              DEBUG_TB_INTERCEPT_REDIRECTS: "false"
              DEFAULT_QUOTA: "1000000000"
              DEFAULT_SPAM_THRESHOLD: "80"
              DISABLE_STATISTICS: "false"
              DKIM_PATH: /dkim/{domain}.{selector}.key
              DKIM_SELECTOR: dkim
              DOMAIN_REGISTRATION: "false"
              FETCHMAIL_ENABLED: "false"
              INSTANCE_ID_PATH: /data/instance
              LOGO_BACKGROUND: none
              LOGO_URL: none
              MEMORY_SESSIONS: "false"
              MESSAGE_RATELIMIT: 200/day
              PERMANENT_SESSION_LIFETIME: "2592000"
              PROXY_AUTH_CREATE: "false"
              PROXY_AUTH_HEADER: X-Auth-Email
              RATELIMIT_STORAGE_URL: redis://dragonfly.databases.svc.cluster.local:6379/2
              SESSION_COOKIE_SECURE: "true"
              SESSION_TIMEOUT: "3600"
              SITENAME: Mailu
              SQLALCHEMY_DATABASE_URI: sqlite:////data/main.db
              SQLALCHEMY_TRACK_MODIFICATIONS: "false"
              SQLITE_DATABASE_FILE: data/main.db
              STATS_ENDPOINT: 19.{}.stats.mailu.io
              TEMPLATES_AUTO_RELOAD: "true"
              WEBSITE: https://mail.hyde.services
              WELCOME: "true"
              WELCOME_BODY: Welcome to Mailu, your new email service. Please change your password and update your profile.
              WELCOME_SUBJECT: Welcome to Mailu
            envFrom:
              - configMapRef:
                  name: "{{ .Release.Name }}-env-configmap"
              - secretRef:
                  name: "{{ .Release.Name }}-secret"
            probes:
              liveness: &adminProbes
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /ping
                    port: &adminPort 8080
                  initialDelaySeconds: 10
                  periodSeconds: 10
                  timeoutSeconds: 1
                  failureThreshold: 3
              readiness: *adminProbes
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
            #  capabilities:
            #    add:
            #      - CHOWN
            #      - SETGID
            #      - SETUID
            #    drop:
            #      - ALL
            resources:
              requests:
                cpu: 10m
                memory: 256Mi
              limits:
                memory: 512Mi
      postfix:
        annotations: *reloader
        containers:
          app:
            image:
              repository: ghcr.io/mailu/postfix
              tag: 2024.06.44@sha256:2f2f0de99f68f7e186a3e02eb625e63627d7a1e0621cbc354cf118249c6849b6
            env:
              REJECT_UNLISTED_RECIPIENT: yes
            envFrom:
              - configMapRef:
                  name: "{{ .Release.Name }}-env-configmap"
            probes:
              liveness: &postfixProbes
                enabled: true
                custom: true
                spec:
                  exec:
                    command:
                      - sh
                      - -c
                      - "! /usr/libexec/postfix/master -t"
                  initialDelaySeconds: 10
                  periodSeconds: 10
                  timeoutSeconds: 1
                  failureThreshold: 3
              readiness: *postfixProbes
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
            #  capabilities:
            #    add:
            #      - NET_BIND_SERVICE
            #      - CHOWN
            #      - SETGID
            #      - SETUID
            #      - DAC_OVERRIDE
            #    drop:
            #      - ALL
            resources:
              requests:
                cpu: 10m
                memory: 128Mi
              limits:
                memory: 256Mi
      dovecot:
        annotations: *reloader
        containers:
          app:
            image:
              repository: ghcr.io/mailu/dovecot
              tag: 2024.06.44@sha256:ead2c24e20ae44d7ca9aa620aab54b2febfbfe2c6c72614ce28ce1e0a8b8bf2e
            env:
              COMPRESSION: lz4
              COMPRESSION_LEVEL: 6
            envFrom:
              - configMapRef:
                  name: "{{ .Release.Name }}-env-configmap"
            probes:
              liveness: &dovecotProbes
                enabled: true
                custom: true
                spec:
                  exec:
                    command:
                      - sh
                      - -c
                      - "kill -0 $(cat /run/dovecot/master.pid)"
                  initialDelaySeconds: 10
                  periodSeconds: 10
                  timeoutSeconds: 10
                  failureThreshold: 3
              readiness: *dovecotProbes
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
            #  capabilities:
            #    add:
            #      - CHOWN
            #      - SETGID
            #      - SETUID
            #      - SYS_CHROOT
            #    drop:
            #      - ALL
            resources:
              requests:
                cpu: 10m
                memory: 256Mi
              limits:
                memory: 512Mi
      rspamd:
        annotations: *reloader
        pod:
          hostname: rspamd
        containers:
          app:
            image:
              repository: ghcr.io/mailu/rspamd
              tag: 2024.06.44@sha256:65462aae8ae7b6caba8d35c074699617a8025a63edf1238121ad50bee20bd4d2
            env:
              ANTIVIRUS: none
              ANTIVIRUS_ACTION: discard
              SCAN_MACROS: false
            envFrom:
              - configMapRef:
                  name: "{{ .Release.Name }}-env-configmap"
            probes:
              startup:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /
                    port: &rspamdPort 11334
                  initialDelaySeconds: 10
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 90
              liveness: &rspamdProbes
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /
                    port: *rspamdPort
                  initialDelaySeconds: 10
                  periodSeconds: 10
                  timeoutSeconds: 1
                  failureThreshold: 3
              readiness: *rspamdProbes
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
            #  capabilities:
            #    drop:
            #      - ALL
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                memory: 512Mi
      webmail:
        annotations: *reloader
        containers:
          app:
            image:
              repository: ghcr.io/mailu/webmail
              tag: 2024.06.44@sha256:782bed176c944e4d6d9bbe583a4e36462e670a6c4acd92ca403744d8a68fb342
            env:
              ROUNDCUBE_DB_FLAVOR: postgresql
              ROUNDCUBE_PLUGINS: |-
                archive,zipdownload,markasjunk,managesieve,enigma,carddav,vcard_attachments,mailu
            envFrom:
              - configMapRef:
                  name: "{{ .Release.Name }}-env-configmap"
              - secretRef:
                  name: "{{ .Release.Name }}-webmail-secret"
            probes:
              liveness: &webmailProbes
                enabled: true
                custom: true
                spec:
                  exec:
                    command:
                      # access forbidden by rule
                      - curl
                      - -f
                      - -L
                      - -H
                      - "User-Agent: health"
                      - http://localhost/ping
                  initialDelaySeconds: 10
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 3
              readiness: *webmailProbes
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
            #  capabilities:
            #    add:
            #      - CHOWN
            #      - SETGID
            #      - SETUID
            #    add:
            #      - CHOWN
            #      - SETGID
            #      - SETUID
            #    drop:
            #      - ALL
            resources:
              requests:
                cpu: 20m
                memory: 128Mi
              limits:
                memory: 256Mi
    defaultPodOptions:
      securityContext:
        #    runAsNonRoot: false
        #    runAsUser: 0
        #    runAsGroup: 0
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
    service:
      front:
        controller: front
        primary: true
        ports:
          http:
            port: *port
          pop3: &pop3
            port: 110
          pop3s: &pop3s
            port: 995
          imap: &imap
            port: 143
          imaps: &imaps
            port: 993
          smtp: &smtp
            port: 25
          smtps: &smtps
            port: 465
          submission: &submission
            port: 587
          lmtp: &lmtp
            port: 2525
          smtp-auth: &smtpAuth
            port: 10025
          imap-auth:
            port: 10143
          sieve:
            port: 14190
      admin:
        controller: admin
        ports:
          http:
            port: *adminPort
      postfix:
        controller: postfix
        ports:
          smtp: *smtp
          smtp-ssl: *smtps
          smtp-starttls: *submission
          smtp-auth: *smtpAuth
      dovecot:
        controller: dovecot
        ports:
          imap-auth:
            port: 2102
          imap-transport: *lmtp
          imap-default: *imap
          pop3: *pop3
          sieve: &sieve
            port: 4190
      rspamd:
        controller: rspamd
        ports:
          rspamd:
            port: 11332
          rspamd-http:
            port: 11334
      webmail:
        controller: webmail
        ports:
          http:
            port: 80
      mail:
        type: LoadBalancer
        controller: front
        annotations:
          lbipam.cilium.io/ips: 192.168.42.150
        externalTrafficPolicy: Local
        ports:
          imap: *imap
          imaps: *imaps
          pop3: *pop3
          pop3s: *pop3s
          smtp: *smtp
          smtps: *smtps
          submission: *submission
          sieve: *sieve
    route:
      app:
        annotations:
          external-dns.alpha.kubernetes.io/cloudflare-proxied: "false"
        hostnames:
          - mail.hyde.services
        parentRefs:
          - name: envoy-external
            namespace: network
            sectionName: https
        rules: &rules
          - backendRefs:
              - name: mailu-front
                port: *port
      autodiscover:
        annotations:
          gatus.home-operations.com/enabled: "false"
        hostnames:
          # ===== HS =====
          - autodiscover.hyde.services
          - autoconfig.hyde.services
          # ===== imagegenius.io =====
          - autodiscover.imagegenius.io
          - autoconfig.imagegenius.io
          # ===== LMVCA =====
          - autodiscover.${D_LMVCA}
          - autoconfig.${D_LMVCA}
        parentRefs:
          - name: envoy-cloudflare
            namespace: network
            sectionName: https
        rules: *rules
    persistence:
      admin-data:
        existingClaim: "{{ .Release.Name }}"
        advancedMounts:
          admin:
            app:
              - path: /data
                subPath: admin
              - path: /dkim
                subPath: dkim
      dovecot-data:
        existingClaim: "{{ .Release.Name }}"
        advancedMounts:
          dovecot:
            app:
              - path: /data
                subPath: dovecotdata
              - path: /mail
                subPath: dovecotmail
      postfix-data:
        existingClaim: "{{ .Release.Name }}-postfix"
        advancedMounts:
          postfix:
            app:
              - path: /queue
                subPath: mailqueue
      rspamd-data:
        existingClaim: "{{ .Release.Name }}-rspamd"
        advancedMounts:
          rspamd:
            app:
              - path: /var/lib/rspamd
                subPath: rspamd
              - path: /etc/rspamd/local.d/maps.d
                subPath: rspamd-local.d-maps.d
      webmail-data:
        existingClaim: "{{ .Release.Name }}-webmail"
        advancedMounts:
          webmail:
            app:
              - path: /data
      certs:
        type: secret
        name: hyde-services-tls
        defaultMode: 0444
        items:
          - key: tls.crt
            path: cert.pem
          - key: tls.key
            path: key.pem
        advancedMounts:
          front:
            app:
              - path: /certs
