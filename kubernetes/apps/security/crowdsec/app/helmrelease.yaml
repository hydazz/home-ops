---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: crowdsec
spec:
  interval: 1h
  chart:
    spec:
      chart: crowdsec
      version: 0.20.0
      sourceRef:
        kind: HelmRepository
        name: crowdsec
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    container_runtime: containerd
    config:
      config.yaml.local: |-
        api:
          server:
            auto_registration:
              enabled: true
              token: "${REGISTRATION_TOKEN}"
              allowed_ranges:
                - 10.42.0.0/16
        db_config:
          type:     postgresql
          user:     ${DB_USERNAME}
          password: ${DB_PASSWORD}
          db_name:  ${DB_NAME}
          host:     ${DB_HOST}
          port:     5432
    lapi:
      env:
        - name: TZ
          value: Australia/Melbourne
        - name: ENROLL_INSTANCE_NAME
          value: home-ops
      envFrom:
        - secretRef:
            name: crowdsec-secret
      persistentVolume:
        data:
          enabled: false
        config:
          enabled: false
    agent:
      isDeployment: true
      additionalAcquisition:
        - source: loki
          url: http://loki-headless.observability.svc.cluster.local:3100
          query: |-
            {app=~".+"} | container =~ `nginx`
            | json
            | line_format "{{ .log }}"
            | regexp "^\\S+\\s+\\S+\\s+\\S+\\s+(?P<message>.+)$"
            | line_format "{{ .message }}"
          labels:
            type: nginx
      env:
        - name: TZ
          value: Australia/Melbourne
        - name: COLLECTIONS
          value: >-
            crowdsecurity/base-http-scenarios
            crowdsecurity/http-cve
            crowdsecurity/nginx
            crowdsecurity/wordpress
