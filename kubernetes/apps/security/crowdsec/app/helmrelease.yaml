---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: crowdsec
spec:
  chartRef:
    kind: OCIRepository
    name: crowdsec
  interval: 1h
  values:
    container_runtime: containerd
    config:
      parsers:
        s01-parse:
          envoy-logs.yaml: |-
            filter: "evt.Parsed.program startsWith 'envoy' && evt.Line.Raw contains ':authority'"
            onsuccess: next_stage
            name: hydaz/envoy-logs
            description: "Parse Envoy access logs to match nginx parser outputs"
            statics:
              - parsed: json
                expression: UnmarshalJSON(evt.Line.Raw, evt.Unmarshaled, "envoy")
              - target: evt.StrTime
                expression: evt.Unmarshaled.envoy.start_time
              - parsed: time_local
                expression: evt.Unmarshaled.envoy.start_time
              - parsed: verb
                expression: evt.Unmarshaled.envoy.method
              - parsed: http_version
                expression: TrimPrefix(evt.Unmarshaled.envoy.protocol, "HTTP/")
              - parsed: request
                expression: evt.Unmarshaled.envoy["x-envoy-origin-path"]
              - parsed: status
                expression: Sprintf('%.0f', evt.Unmarshaled.envoy.response_code)
              - parsed: body_bytes_sent
                expression: Sprintf('%.0f', evt.Unmarshaled.envoy.bytes_sent)
              - parsed: http_user_agent
                expression: evt.Unmarshaled.envoy["user-agent"]
              - parsed: target_fqdn
                expression: evt.Unmarshaled.envoy[":authority"]
              - parsed: remote_addr
                expression: Split(evt.Unmarshaled.envoy["x-forwarded-for"], ",")[0]
              - meta: service
                value: http
              - meta: log_type
                value: http_access-log
              - meta: http_path
                expression: evt.Parsed.request
              - meta: http_status
                expression: evt.Parsed.status
              - meta: http_verb
                expression: evt.Parsed.verb
              - meta: http_user_agent
                expression: evt.Parsed.http_user_agent
              - meta: target_fqdn
                expression: evt.Parsed.target_fqdn
              - meta: source_ip
                expression: evt.Parsed.remote_addr
              - meta: bytes_received
                expression: Sprintf('%.0f', evt.Unmarshaled.envoy.bytes_received)
              - meta: duration_ms
                expression: Sprintf('%.0f', evt.Unmarshaled.envoy.duration)
              - meta: request_id
                expression: evt.Unmarshaled.envoy["x-request-id"]
      config.yaml.local: |-
        api:
          server:
            auto_registration:
              enabled: true
              token: "${REGISTRATION_TOKEN}"
              allowed_ranges:
                - 10.42.0.0/16
        db_config:
          type: postgresql
          user: ${DB_USERNAME}
          password: ${DB_PASSWORD}
          db_name: ${DB_NAME}
          host: ${DB_HOST}
          port: 5432
      notifications:
        pushover.yaml: |-
          type: http
          name: pushover
          log_level: debug
          url: https://api.pushover.net/1/messages.json
          method: POST
          headers:
            Content-Type: application/json
          format: |-
            {
              "token": "{{ env "CROWDSEC_PUSHOVER_TOKEN" }}",
              "user": "{{ env "PUSHOVER_USER_KEY" }}",
              "title": "üö® CrowdSec Security Alert",
              "html": "1",
              "url": "https://app.crowdsec.net/cti/{{range . -}}{{$alert := . -}}{{range .Decisions -}}{{.Value}}{{end -}}{{end -}}",
              "url_title": "View in CrowdSec Console",
              "message": "{{range . -}}{{$alert := . -}}{{range .Decisions -}}<b>üîí Security Threat Detected</b>

            <b>üåê Target Information:</b>
            ‚Ä¢ <b>IP Address:</b> {{.Value}}{{$domain := GetMeta $alert "target_fqdn" | join ", "}}{{if ne $domain ""}}
            ‚Ä¢ <b>Domain:</b> {{$domain}}{{end}}{{$path := GetMeta $alert "http_path" | join ", "}}{{if ne $path ""}}
            ‚Ä¢ <b>Path:</b> {{$path}}{{end}}

            <b>üõ°Ô∏è Action Taken:</b>
            ‚Ä¢ <b>Type:</b> {{.Type | title}}
            ‚Ä¢ <b>Duration:</b> {{.Duration}}
            ‚Ä¢ <b>Scenario:</b> {{.Scenario}}
            ‚Ä¢ <b>Timestamp:</b> {{$alert.StartAt}}

            <b>üìä Request Details:</b>{{$verb := GetMeta $alert "http_verb" | join ", "}}{{if ne $verb ""}}
            ‚Ä¢ <b>Method:</b> {{$verb}}{{end}}{{$status := GetMeta $alert "http_status" | join ", "}}{{if ne $status ""}}
            ‚Ä¢ <b>Status:</b> {{$status}}{{end}}{{$agent := GetMeta $alert "http_user_agent" | join ", "}}{{if ne $agent ""}}
            ‚Ä¢ <b>User Agent:</b> {{$agent}}{{end}}

            <b>üåç Geographic Info:</b>{{if $alert.Source.Cn}}
            ‚Ä¢ <b>Country:</b> {{$alert.Source.Cn}}{{end}}{{$asnOrg := GetMeta $alert "ASNOrg" | join ", "}}{{$asnNum := GetMeta $alert "ASNNumber" | join ", "}}{{if and (ne $asnOrg "") (ne $asnNum "")}}
            ‚Ä¢ <b>ASN:</b> {{$asnOrg}} ({{$asnNum}}){{end}}

            <b>üîó Investigation Links:</b>
            ‚Ä¢ <a href=\"https://www.shodan.io/host/{{.Value}}\">üîé Shodan Report</a>
            ‚Ä¢ <a href=\"https://www.whois.com/whois/{{.Value}}\">üìã WHOIS Lookup</a>
            ‚Ä¢ <a href=\"https://app.crowdsec.net/cti/{{.Value}}\">üõ°Ô∏è CrowdSec CTI</a>
            ‚Ä¢ <a href=\"https://www.abuseipdb.com/check/{{.Value}}\">üö® AbuseIPDB</a>{{end -}}{{end -}}"
            }
      profiles.yaml: |-
        name: default_ip_remediation
        debug: false
        filters:
          - Alert.Remediation == true && Alert.GetScope() == "Ip"
        notifications:
          - pushover
        decisions:
          - type: ban
            duration: 24h
        on_success: break
    lapi:
      strategy:
        type: RollingUpdate
      env:
        - name: TZ
          value: Australia/Melbourne
        - name: ENROLL_INSTANCE_NAME
          value: home-ops
      envFrom:
        - secretRef:
            name: crowdsec-secret
      persistentVolume:
        data:
          enabled: false
        config:
          enabled: false
      metrics:
        enabled: true
        serviceMonitor:
          enabled: true
    agent:
      isDeployment: true
      strategy:
        type: RollingUpdate
      additionalAcquisition:
        # loki is used as the built in log file acquisition sucks
        - source: loki
          url: http://loki-headless.observability.svc.cluster.local:3100
          query: |-
            {app="envoy"}
            | json
            | line_format "{{ .log }}"
          labels:
            type: envoy
      env:
        - name: COLLECTIONS
          value: >-
            crowdsecurity/base-http-scenarios
            crowdsecurity/http-cve
            crowdsecurity/wordpress
        - name: SCENARIOS
          value: >-
            crowdsecurity/http-bf-wordpress_bf_xmlrpc
        - name: TZ
          value: Australia/Melbourne
      metrics:
        enabled: true
        serviceMonitor:
          enabled: true
    appsec:
      enabled: true
      strategy:
        type: RollingUpdate
      acquisitions:
        - source: appsec
          listen_addr: "0.0.0.0:7422"
          path: /
          appsec_config: crowdsecurity/appsec-default
          labels:
            type: appsec
      env:
        - name: APPSEC_CONFIGS
          value: >-
            crowdsecurity/appsec-default
        - name: COLLECTIONS
          value: >-
            crowdsecurity/appsec-generic-rules
            crowdsecurity/appsec-virtual-patching
            crowdsecurity/appsec-wordpress
        - name: TZ
          value: Australia/Melbourne
      metrics:
        enabled: true
        serviceMonitor:
          enabled: true
