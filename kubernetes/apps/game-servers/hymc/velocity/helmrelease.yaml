---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: hymc-velocity
spec:
  chartRef:
    kind: OCIRepository
    name: hymc-velocity
  interval: 1h
  values:
    image:
      repository: ghcr.io/itzg/mc-proxy
      tag: 2025.9.1@sha256:a128af22c71f0cef238076787dda8db1eddda65a60ba8a1a69a83a7f6c5a2c15
    extraEnv:
      TZ: Australia/Melbourne
    minecraftProxy:
      type: VELOCITY
      velocityVersion: 3.4.0-SNAPSHOT
      onlineMode: true
      memory: 1G
      plugins:
        - https://hangarcdn.papermc.io/plugins/ViaVersion/ViaBackwards/versions/5.5.0/PAPER/ViaBackwards-5.5.0.jar
        - https://hangarcdn.papermc.io/plugins/ViaVersion/ViaRewind/versions/4.0.9/PAPER/ViaRewind-4.0.9.jar
        - https://hangarcdn.papermc.io/plugins/ViaVersion/ViaVersion/versions/5.5.0/PAPER/ViaVersion-5.5.0.jar
      serviceType: LoadBalancer
      serviceAnnotations:
        lbipam.cilium.io/ips: 192.168.42.154
      externalTrafficPolicy: Local
      configFilePath: /server/velocity.toml
      config: |-
        config-version = "2.7"
        bind = "0.0.0.0:25565"
        motd = "<#09add3>A Velocity Server"
        show-max-players = 100
        online-mode = true
        force-key-authentication = true
        prevent-client-proxy-connections = false
        player-info-forwarding-mode = "legacy"
        forwarding-secret-file = "forwarding.secret"
        announce-forge = false
        kick-existing-players = false
        ping-passthrough = "DISABLED"
        enable-player-address-logging = true

        [servers]
        lobby = "hymc-lobby-minecraft.game-servers.svc.cluster.local:25565"
        pvp = "hymc-pvp-minecraft.game-servers.svc.cluster.local:25565"
        try = ["lobby"]

        [forced-hosts]

        [advanced]
        read-timeout = 30000
        tcp-fast-open = false
        compression-level = -1
        compression-threshold = 256
        login-ratelimit = 3000
        connection-timeout = 5000
        log-player-connections = true
        bungee-plugin-message-channel = true
        show-ping-requests = false
        accepts-transfers = false
        failover-on-unexpected-server-disconnect = true
        announce-proxy-commands = true
        haproxy-protocol = false
        log-command-executions = false

        [query]
        port = 25577
        show-plugins = false
        map = "Velocity"
        enabled = true
    resources:
      requests:
        cpu: 30m
        memory: 1Gi
      limits:
        memory: 2Gi
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities: {drop: ["ALL"]}
    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000
      fsGroupChangePolicy: OnRootMismatch
    persistence:
      dataDir:
        enabled: true
        existingClaim: hymc-velocity
    extraVolumes:
      - volumeMounts:
          - name: forwarding-secret
            mountPath: /server/forwarding.secret
            subPath: forwarding.secret
        volumes:
          - name: forwarding-secret
            secret:
              secretName: &secret velocity-secret
    podAnnotations:
      secret.reloader.stakater.com/reload: *secret
