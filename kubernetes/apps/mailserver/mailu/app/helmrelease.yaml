---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app mailu
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: mailu
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    controllers:
      front:
        annotations:
          reloader.stakater.com/auto: "true"
        strategy: Recreate
        containers:
          app:
            image:
              repository: ghcr.io/mailu/nginx
              tag: 2024.06.43
            env: &env
              TZ: Australia/Melbourne
              # Core Mailu configuration
              DOMAIN: &domain ${D_HS}
              HOSTNAMES: mail.${D_HS}
              SUBNET: 10.42.0.0/16
              SUBNET6: fd42::/48
              SITENAME: Mailu
              WEBSITE: https://mail.${D_HS}
              LOGO_URL: none
              LOGO_BACKGROUND: none
              # Database configuration
              DB_FLAVOR: postgresql
              DB_HOST: postgres-rw.databases.svc.cluster.local:5432
              DB_NAME: mailu
              DB_USER: mailu
              # Redis configuration
              RATELIMIT_STORAGE_URL: redis://dragonfly.databases.svc.cluster.local:6379/2
              # Mail configuration
              MESSAGE_SIZE_LIMIT: "67108864"
              MESSAGE_RATELIMIT: 200/day
              AUTH_RATELIMIT_IP: 60/hour
              AUTH_RATELIMIT_USER: 100/day
              # Webmail configuration
              WEB_ADMIN: /admin
              WEB_WEBMAIL: /webmail
              WEBROOT_REDIRECT: /webmail
              ROUNDCUBE_DB_FLAVOR: postgresql
              ROUNDCUBE_DB_HOST: postgres-rw.databases.svc.cluster.local:5432
              ROUNDCUBE_DB_NAME: roundcube
              ROUNDCUBE_DB_USER: roundcube
              # Security configuration
              TLS_FLAVOR: mail
              REAL_IP_FROM: 0.0.0.0/0
              REAL_IP_HEADER: X-Forwarded-For
              SESSION_COOKIE_SECURE: "true"
              # Features
              ADMIN: "true"
              FETCHMAIL_ENABLED: "false"
              ANTIVIRUS_ACTION: discard
              ANTIVIRUS: none
              # Compression
              COMPRESSION: lz4
              COMPRESSION_LEVEL: "6"
              # Service addresses
              FRONT_ADDRESS: mailu-front.mailserver.svc.cluster.local
              ADMIN_ADDRESS: mailu-admin.mailserver.svc.cluster.local
              SMTP_ADDRESS: mailu-postfix.mailserver.svc.cluster.local
              IMAP_ADDRESS: mailu-dovecot.mailserver.svc.cluster.local
              ANTISPAM_ADDRESS: mailu-rspamd.mailserver.svc.cluster.local
              WEBMAIL_ADDRESS: mailu-webmail.mailserver.svc.cluster.local
              REDIS_ADDRESS: dragonfly.databases.svc.cluster.local
              # Initial admin configuration
              INITIAL_ADMIN_MODE: ifmissing
              INITIAL_ADMIN_ACCOUNT: alex
              INITIAL_ADMIN_DOMAIN: *domain
              # Webmail configuration
              WEBMAIL: roundcube
              ROUNDCUBE_PLUGINS: archive,zipdownload,markasjunk,managesieve,enigma,carddav,vcard_attachments,mailu
              # Additional settings
              PORTS: 110,995,143,993,25,465,587,4190
              LOG_LEVEL: WARNING
              DEBUG: "false"
              WELCOME: "true"
              WELCOME_SUBJECT: Welcome to Mailu
              WELCOME_BODY: Welcome to Mailu, your new email service. Please change your password and update your profile.
              POSTMASTER: postmaster
              # Mailu Helm Chart compatibility
              MAILU_HELM_CHART: "true"
              I_KNOW_MY_SETUP_DOESNT_FIT_REQUIREMENTS_AND_WONT_FILE_ISSUES_WITHOUT_PATCHES: "true"
            envFrom:
              - secretRef:
                  name: &secret mailu-secret
            probes:
              liveness: &probes
                enabled: true
                custom: true
                spec:
                  exec:
                    command:
                      - /bin/sh
                      - -c
                      - "curl -f -L http://localhost/ || exit 1"
                  initialDelaySeconds: 10
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 3
              readiness: *probes
            securityContext: &securityContext
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
              capabilities:
                add:
                  - NET_BIND_SERVICE
                drop:
                  - ALL
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                memory: 1Gi
      admin:
        annotations:
          reloader.stakater.com/auto: "true"
        strategy: Recreate
        containers:
          app:
            image:
              repository: ghcr.io/mailu/admin
              tag: 2024.06.43
            env:
              <<: *env
              QUOTA_STORAGE_URL: redis://dragonfly.databases.svc.cluster.local:6379/1
            envFrom:
              - secretRef:
                  name: *secret
            probes:
              liveness: &adminProbes
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /ping
                    port: &adminPort 8080
                  initialDelaySeconds: 10
                  periodSeconds: 10
                  timeoutSeconds: 1
                  failureThreshold: 3
              readiness: *adminProbes
            securityContext:
              <<: *securityContext
              capabilities:
                drop:
                  - ALL
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                memory: 1Gi
      postfix:
        annotations:
          reloader.stakater.com/auto: "true"
        strategy: Recreate
        containers:
          app:
            image:
              repository: ghcr.io/mailu/postfix
              tag: 2024.06.43
            env:
              <<: *env
            envFrom:
              - secretRef:
                  name: *secret
            probes:
              startup:
                enabled: true
                custom: true
                spec:
                  exec:
                    command:
                      - /bin/sh
                      - -c
                      - "ss -lntp | grep -q :25"
                  initialDelaySeconds: 10
                  periodSeconds: 10
                  timeoutSeconds: 1
                  failureThreshold: 30
              liveness: &postfixProbes
                enabled: true
                custom: true
                spec:
                  exec:
                    command:
                      - /bin/sh
                      - -c
                      - "ss -lntp | grep -q :25"
                  initialDelaySeconds: 10
                  periodSeconds: 10
                  timeoutSeconds: 1
                  failureThreshold: 3
              readiness: *postfixProbes
            securityContext: *securityContext
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                memory: 1Gi
      dovecot:
        annotations:
          reloader.stakater.com/auto: "true"
        strategy: Recreate
        containers:
          app:
            image:
              repository: ghcr.io/mailu/dovecot
              tag: 2024.06.43
            env:
              <<: *env
            envFrom:
              - secretRef:
                  name: *secret
            probes:
              liveness: &dovecotProbes
                enabled: true
                custom: true
                spec:
                  exec:
                    command:
                      - /bin/sh
                      - -c
                      - "ss -lntp | grep -q :993"
                  initialDelaySeconds: 10
                  periodSeconds: 10
                  timeoutSeconds: 10
                  failureThreshold: 3
              readiness: *dovecotProbes
            securityContext: *securityContext
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                memory: 1Gi
      rspamd:
        annotations:
          reloader.stakater.com/auto: "true"
        strategy: Recreate
        pod:
          hostname: rspamd
        containers:
          app:
            image:
              repository: ghcr.io/mailu/rspamd
              tag: 2024.06.43
            env:
              <<: *env
            envFrom:
              - secretRef:
                  name: *secret
            probes:
              startup:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /
                    port: &rspamdPort 11334
                  initialDelaySeconds: 10
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 90
              liveness: &rspamdProbes
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /
                    port: *rspamdPort
                  initialDelaySeconds: 10
                  periodSeconds: 10
                  timeoutSeconds: 1
                  failureThreshold: 3
              readiness: *rspamdProbes
            securityContext:
              <<: *securityContext
              capabilities:
                drop:
                  - ALL
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                memory: 1Gi
      webmail:
        annotations:
          reloader.stakater.com/auto: "true"
        strategy: Recreate
        containers:
          app:
            image:
              repository: ghcr.io/mailu/webmail
              tag: 2024.06.43
            env:
              <<: *env
            envFrom:
              - secretRef:
                  name: *secret
            probes:
              liveness: &webmailProbes
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /
                    port: &webmailPort 80
                  initialDelaySeconds: 10
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 3
              readiness: *webmailProbes
            securityContext:
              <<: *securityContext
              capabilities:
                drop:
                  - ALL
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                memory: 1Gi
    defaultPodOptions:
      securityContext:
        runAsNonRoot: false
        runAsUser: 0
        runAsGroup: 0
        fsGroup: 0
        fsGroupChangePolicy: OnRootMismatch
      terminationGracePeriodSeconds: 2
    service:
      front:
        controller: front
        ports:
          http:
            port: &httpPort 80
          https:
            port: 443
          pop3:
            port: 110
          pop3s:
            port: 995
          imap:
            port: 143
          imaps:
            port: 993
          smtp:
            port: 25
          smtps:
            port: 465
          submission:
            port: 587
          lmtp:
            port: 2525
          smtp-auth:
            port: 10025
          imap-auth:
            port: 10143
          sieve:
            port: 14190
      admin:
        controller: admin
        ports:
          http:
            port: *adminPort
      postfix:
        controller: postfix
        ports:
          smtp:
            port: 25
          smtp-ssl:
            port: 465
          smtp-starttls:
            port: 587
          smtp-auth:
            port: 10025
      dovecot:
        controller: dovecot
        ports:
          imap-auth:
            port: 2102
          imap-transport:
            port: 2525
          imap-default:
            port: 143
          pop3:
            port: 110
          sieve:
            port: 4190
      rspamd:
        controller: rspamd
        ports:
          rspamd:
            port: 11332
          rspamd-http:
            port: *rspamdPort
      webmail:
        controller: webmail
        ports:
          http:
            port: *webmailPort
      mail:
        type: LoadBalancer
        controller: front
        annotations:
          lbipam.cilium.io/ips: 192.168.42.150
        externalTrafficPolicy: Local
        ports:
          # IMAP
          imap:
            port: 143
            protocol: TCP
          imaps:
            port: 993
            protocol: TCP
          # POP3
          pop3:
            port: 110
            protocol: TCP
          pop3s:
            port: 995
            protocol: TCP
          # SMTP
          smtp:
            port: 25
            protocol: TCP
          smtps:
            port: 465
            protocol: TCP
          submission:
            port: 587
            protocol: TCP
          # ManageSieve
          sieve:
            port: 4190
            protocol: TCP
    route:
      app:
        annotations:
          external-dns.alpha.kubernetes.io/cloudflare-proxied: "false"
        hostnames:
          - mail.${D_HS}
        parentRefs:
          - name: external
            namespace: kube-system
            sectionName: https-hs
        rules:
          - backendRefs:
              - name: mailu-front
                port: *httpPort
      autodiscover:
        hostnames:
          # ===== HS =====
          - autodiscover.${D_HS}
          - autoconfig.${D_HS}
          # ===== IGI =====
          - autodiscover.${D_IGI}
          - autoconfig.${D_IGI}
          # ===== LMVCA =====
          - autodiscover.${D_LMVCA}
          - autoconfig.${D_LMVCA}
        parentRefs:
          - name: cloudflare
            namespace: kube-system
            sectionName: https-hs
          - name: cloudflare
            namespace: kube-system
            sectionName: https-igi
          - name: cloudflare
            namespace: kube-system
            sectionName: https-lmvca
        rules:
          - backendRefs:
              - name: mailu-front
                port: *httpPort
    persistence:
      admin-data:
        existingClaim: mailu
        advancedMounts:
          admin:
            app:
              - path: /data
                subPath: admin
              - path: /dkim
                subPath: dkim
      dovecot-data:
        existingClaim: mailu
        advancedMounts:
          dovecot:
            app:
              - path: /data
                subPath: dovecotdata
              - path: /mail
                subPath: dovecotmail
      postfix-data:
        existingClaim: mailu-postfix
        advancedMounts:
          postfix:
            app:
              - path: /queue
                subPath: mailqueue
      rspamd-data:
        existingClaim: mailu-rspamd
        advancedMounts:
          rspamd:
            app:
              - path: /var/lib/rspamd
                subPath: rspamd
              - path: /etc/rspamd/local.d/maps.d
                subPath: rspamd-local.d-maps.d
      webmail-data:
        existingClaim: mailu-webmail
        advancedMounts:
          webmail:
            app:
              - path: /data
      certs:
        type: secret
        name: ${D_HS//./-}-tls
        defaultMode: 0444
        advancedMounts:
          front:
            app:
              - path: /certs
                readOnly: true
